{% extends 'base.html' %}
{% block title %}Pest Control Guide{% endblock %}
{% block page_title %}ğŸ› Pest & Disease Control{% endblock %}
{% block page_subtitle %}Find the right pesticide for any pest or disease on your crop{% endblock %}
{% block extra_head %}
<style>
.pest-card{border-radius:14px;border:2px solid var(--cream-dark);background:#fff;padding:18px 20px;margin-bottom:12px;transition:all .15s;}
.pest-card:hover{border-color:var(--green-light);box-shadow:0 4px 16px rgba(0,0,0,.08);}
.pest-type-badge{padding:4px 12px;border-radius:20px;font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;display:inline-block;}
.type-insect  {background:#fee2e2;color:#991b1b;}
.type-disease {background:#fef9c3;color:#854d0e;}
.type-weed    {background:#dcfce7;color:#166534;}
.type-mite    {background:#f3e8ff;color:#7e22ce;}
.safety-box{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border-radius:8px;font-size:.78rem;font-weight:600;}
.safety-ok{background:#dcfce7;color:#166534;}
.safety-warn{background:#fef9c3;color:#854d0e;}
.safety-danger{background:#fee2e2;color:#991b1b;}
.qty-large{font-family:'Lora',serif;font-size:1.2rem;font-weight:700;color:var(--amber-dark);}
.pest-type-filter{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.type-btn{padding:6px 16px;border-radius:20px;border:2px solid var(--cream-dark);background:#fff;font-size:.82rem;font-weight:600;cursor:pointer;transition:all .15s;}
.type-btn.active,.type-btn:hover{background:var(--green-mid);color:#fff;border-color:var(--green-mid);}
</style>
{% endblock %}
{% block content %}
<div class="row g-4">
  <!-- LEFT: Form -->
  <div class="col-lg-4">
    <div class="card sticky-top" style="top:20px;">
      <div class="card-header"><i class="bi bi-bug text-danger"></i> Select Crop</div>
      <div class="card-body">
        <form method="POST" id="pestForm">
          <div class="mb-3">
            <label class="form-label">ğŸŒ¾ Crop Name *</label>
            <select name="crop_name" class="form-select" required onchange="this.form.submit()">
              <option value="">-- Select Crop --</option>
              {% for c in all_crops %}
              <option value="{{ c }}" {% if c == crop_name %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
          </div>
          {% if crop_name %}
          <div class="mb-3">
            <label class="form-label">ğŸ” Filter by Type</label>
            <select name="pest_type" class="form-select">
              <option value="">All Types</option>
              <option value="Insect"  {% if pest_type=='Insect' %}selected{% endif %}>ğŸ¦— Insect Pests</option>
              <option value="Disease" {% if pest_type=='Disease' %}selected{% endif %}>ğŸ„ Diseases</option>
              <option value="Weed"    {% if pest_type=='Weed' %}selected{% endif %}>ğŸŒ¿ Weeds</option>
              <option value="Mite"    {% if pest_type=='Mite' %}selected{% endif %}>ğŸ•·ï¸ Mites</option>
            </select>
          </div>
          <button type="submit" class="btn btn-farm w-100">
            <i class="bi bi-search me-2"></i>Show Recommendations
          </button>
          {% endif %}
        </form>

        <div class="mt-3 p-3" style="background:#fee2e2;border-radius:10px;border-left:4px solid #dc2626;">
          <div style="font-size:.78rem;font-weight:700;color:#991b1b;">âš ï¸ Safety Warning</div>
          <div style="font-size:.78rem;color:#991b1b;margin-top:4px;">
            Always wear gloves and mask while handling pesticides.
            Follow label instructions strictly. Keep children away from treated fields.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT: Results -->
  <div class="col-lg-8">
    {% if searched and results %}
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h5 style="font-family:'Lora',serif;color:var(--green-dark);margin:0;">
        Pest Control Guide â€” {{ crop_name }}
      </h5>
      <span style="font-size:.78rem;color:var(--text-muted);">{{ results|length }} entries</span>
    </div>

    <!-- Type Filter Buttons -->
    <div class="pest-type-filter">
      <button class="type-btn active" onclick="filterType('all',this)">All ({{ results|length }})</button>
      {% set types = results|map(attribute='pest_type')|unique|list %}
      {% for t in types %}
      <button class="type-btn" onclick="filterType('{{ t }}',this)">
        {% if t=='Insect' %}ğŸ¦—{% elif t=='Disease' %}ğŸ„{% elif t=='Weed' %}ğŸŒ¿{% else %}ğŸ•·ï¸{% endif %}
        {{ t }} ({{ results|selectattr('pest_type','eq',t)|list|length }})
      </button>
      {% endfor %}
    </div>

    {% for r in results %}
    <div class="pest-card" data-type="{{ r.pest_type }}">
      <div class="row g-3 align-items-start">
        <div class="col-sm-7">
          <div class="d-flex align-items-center gap-2 mb-2">
            <span class="pest-type-badge type-{{ r.pest_type|lower if r.pest_type else 'disease' }}">
              {% if r.pest_type=='Insect' %}ğŸ¦—{% elif r.pest_type=='Disease' %}ğŸ„{% elif r.pest_type=='Weed' %}ğŸŒ¿{% else %}ğŸ•·ï¸{% endif %}
              {{ r.pest_type or 'Disease' }}
            </span>
          </div>
          <div style="font-weight:700;font-size:1rem;color:#991b1b;">ğŸ¯ {{ r.pest_name }}</div>
          <div style="font-size:.88rem;color:var(--green-dark);margin-top:6px;">
            <strong>ğŸ’Š Pesticide:</strong> {{ r.pesticide_name }}
          </div>
          {% if r.spray_interval %}
          <div style="font-size:.8rem;color:var(--text-muted);margin-top:4px;">
            <i class="bi bi-clock"></i> {{ r.spray_interval }}
          </div>
          {% endif %}
          {% if r.notes %}
          <div style="font-size:.78rem;color:var(--text-mid);margin-top:8px;background:var(--cream);border-radius:6px;padding:7px 10px;">
            {{ r.notes }}
          </div>
          {% endif %}
        </div>
        <div class="col-sm-5 text-sm-end">
          {% if r.quantity_acre and r.quantity_acre != 'â€”' %}
          <div style="font-size:.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;">Quantity</div>
          <div class="qty-large">{{ r.quantity_acre }}</div>
          <div style="font-size:.68rem;color:var(--text-muted);">per acre / per 200L water</div>
          {% endif %}
          {% if r.safety_days is not none %}
          <div class="mt-2">
            {% if r.safety_days == 0 %}
            <span class="safety-box safety-ok">âœ… Safe â€” Seed/Soil Treatment</span>
            {% elif r.safety_days <= 7 %}
            <span class="safety-box safety-ok">âœ… {{ r.safety_days }} days pre-harvest safe</span>
            {% elif r.safety_days <= 14 %}
            <span class="safety-box safety-warn">âš ï¸ {{ r.safety_days }} days before harvest</span>
            {% else %}
            <span class="safety-box safety-danger">ğŸš¨ {{ r.safety_days }} days pre-harvest wait</span>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}

    <div style="background:#f0fdf4;border-radius:12px;padding:16px 18px;margin-top:16px;border:1.5px solid #86efac;">
      <strong style="color:#166534;">ğŸ“‹ General Spraying Guidelines:</strong>
      <ul style="margin:8px 0 0;padding-left:18px;font-size:.83rem;color:#166534;">
        <li>Always add a sticker/spreader (Triton / Sandovit) to pesticide solution for better adhesion</li>
        <li>Spray in early morning (6-9 AM) or evening (4-7 PM) â€” never in hot afternoon</li>
        <li>Do not spray before rain forecast â€” minimum 4 hours dry weather needed after spraying</li>
        <li>Rotate pesticide groups to prevent resistance development in pests</li>
        <li>Never mix two pesticides without checking compatibility</li>
      </ul>
    </div>

    {% elif searched %}
    <div class="card text-center py-5">
      <div style="font-size:3.5rem;">ğŸ›</div>
      <h5 class="mt-3">No data for this crop</h5>
    </div>
    {% else %}
    <div class="card text-center py-5">
      <div style="font-size:4rem;">ğŸ›</div>
      <h4 class="mt-3" style="color:var(--green-dark);">Select a crop to view pest control guide</h4>
      <p class="text-muted">Choose a crop from the left panel to see pest and disease management advice.</p>
      <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
        {% for c in all_crops[:5] %}
        <form method="POST" style="display:inline;">
          <input type="hidden" name="crop_name" value="{{ c }}">
          <button type="submit" class="btn btn-sm btn-outline-farm">ğŸŒ¿ {{ c }}</button>
        </form>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
function filterType(type, btn) {
  document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.pest-card').forEach(card => {
    card.style.display = (type === 'all' || card.dataset.type === type) ? '' : 'none';
  });
}
</script>
{% endblock %}