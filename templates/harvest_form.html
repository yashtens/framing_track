{% extends 'base.html' %}
{% block title %}{{ 'Edit Harvest' if harvest else 'Record Harvest' }}{% endblock %}
{% block page_title %}{{ '‚úèÔ∏è Edit Harvest' if harvest else 'üåæ Record Harvest' }}{% endblock %}
{% block page_subtitle %}Enter production and income details{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-basket3 text-success"></i> Harvest Details
      </div>
      <div class="card-body p-4">
        <form method="POST">
          <div class="row g-3">
            <div class="col-sm-6">
              <label class="form-label">Crop *</label>
              <select name="crop_id" class="form-select" required>
                <option value="">Select Crop</option>
                {% for c in crops %}
                <option value="{{ c.id }}"
                  {% if harvest and harvest.crop_id == c.id %}selected{% endif %}>
                  {{ c.name }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-sm-6">
              <label class="form-label">Harvest Date *</label>
              <input type="date" name="harvest_date" class="form-control"
                     value="{{ harvest.harvest_date.strftime('%Y-%m-%d') if harvest else '' }}" required>
            </div>
            <div class="col-sm-6">
              <label class="form-label">Total Production *</label>
              <input type="number" step="0.01" min="0" name="total_production"
                     class="form-control" id="prodInput"
                     value="{{ harvest.total_production if harvest else '' }}"
                     placeholder="e.g. 1500" required>
            </div>
            <div class="col-sm-6">
              <label class="form-label">Unit</label>
              <select name="unit" class="form-select" id="unitSelect">
                <option value="kg"      {% if harvest and harvest.unit=='kg'      %}selected{% endif %}>kg</option>
                <option value="quintal" {% if harvest and harvest.unit=='quintal' %}selected{% endif %}>Quintal</option>
                <option value="tonne"   {% if harvest and harvest.unit=='tonne'   %}selected{% endif %}>Tonne</option>
                <option value="box"     {% if harvest and harvest.unit=='box'     %}selected{% endif %}>Box</option>
                <option value="bag"     {% if harvest and harvest.unit=='bag'     %}selected{% endif %}>Bag</option>
              </select>
            </div>
            <div class="col-sm-6">
              <label class="form-label">Selling Price per Unit (‚Çπ) *</label>
              <div class="input-group">
                <span class="input-group-text">‚Çπ</span>
                <input type="number" step="0.01" min="0" name="selling_price"
                       class="form-control" id="priceInput"
                       value="{{ harvest.selling_price if harvest else '' }}"
                       placeholder="0" required>
                <span class="input-group-text" id="unitLabel">/ kg</span>
              </div>
            </div>
            <!-- Auto Total Income -->
            <div class="col-sm-6">
              <label class="form-label" style="color:var(--green-dark);font-weight:700;">
                Total Income (‚Çπ) ‚Äî Auto
              </label>
              <div class="input-group">
                <span class="input-group-text" style="background:var(--green-pale);color:var(--green-dark);font-weight:700;">‚Çπ</span>
                <input type="text" id="incomeDisplay" class="form-control"
                       style="background:var(--green-pale);font-weight:700;font-size:1.15rem;color:var(--green-dark);"
                       readonly>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea name="notes" class="form-control" rows="2"
                        placeholder="Market name, buyer details, quality notes‚Ä¶">{{ harvest.notes if harvest else '' }}</textarea>
            </div>

            <div class="col-12">
              <div style="background:var(--amber-pale);border-radius:10px;padding:12px 16px;font-size:.85rem;color:var(--amber-dark);">
                <strong>‚ÑπÔ∏è Note:</strong> Recording a harvest will automatically mark the crop as
                <strong>Harvested</strong>.
              </div>
            </div>
          </div>

          <div class="d-flex gap-3 mt-4">
            <button type="submit" class="btn btn-farm px-5">
              <i class="bi bi-check-lg me-1"></i>
              {{ 'Update' if harvest else 'Save Harvest' }}
            </button>
            <a href="{{ url_for('harvest') }}" class="btn btn-outline-secondary px-4">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const prod   = document.getElementById('prodInput');
  const price  = document.getElementById('priceInput');
  const income = document.getElementById('incomeDisplay');
  const unitS  = document.getElementById('unitSelect');
  const unitL  = document.getElementById('unitLabel');

  function calc() {
    const total = (parseFloat(prod.value)||0) * (parseFloat(price.value)||0);
    income.value = '‚Çπ' + total.toLocaleString('en-IN', {minimumFractionDigits: 2});
    unitL.textContent = '/ ' + unitS.value;
  }

  prod.addEventListener('input',  calc);
  price.addEventListener('input', calc);
  unitS.addEventListener('change',calc);
  calc();
</script>
{% endblock %}