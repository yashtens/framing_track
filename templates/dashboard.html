{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Welcome back, {{ session.get('username','Admin') }}! Here's your farm overview.{% endblock %}

{% block content %}

<!-- ‚îÄ‚îÄ Stat Cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="row g-3 mb-4">
  <div class="col-6 col-lg-3">
    <div class="stat-card stat-green">
      <div class="stat-icon">üå±</div>
      <div class="stat-value">{{ total_crops }}</div>
      <div class="stat-label">Total Crops</div>
      <small style="opacity:.7">{{ growing_crops }} growing ¬∑ {{ harvested_crops }} harvested</small>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="stat-card stat-soil">
      <div class="stat-icon">üí∏</div>
      <div class="stat-value">‚Çπ{{ '{:,.0f}'.format(total_investment) }}</div>
      <div class="stat-label">Total Investment</div>
      <small style="opacity:.7">All crops combined</small>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="stat-card stat-amber">
      <div class="stat-icon">üè™</div>
      <div class="stat-value">‚Çπ{{ '{:,.0f}'.format(total_income) }}</div>
      <div class="stat-label">Total Income</div>
      <small style="opacity:.7">From all harvests</small>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    {% if profit_loss >= 0 %}
    <div class="stat-card stat-profit">
      <div class="stat-icon">üìà</div>
      <div class="stat-value">‚Çπ{{ '{:,.0f}'.format(profit_loss) }}</div>
      <div class="stat-label">Net Profit</div>
      <small style="opacity:.7">Income ‚àí Investment</small>
    </div>
    {% else %}
    <div class="stat-card stat-loss">
      <div class="stat-icon">üìâ</div>
      <div class="stat-value">‚Çπ{{ '{:,.0f}'.format(profit_loss|abs) }}</div>
      <div class="stat-label">Net Loss</div>
      <small style="opacity:.7">Income ‚àí Investment</small>
    </div>
    {% endif %}
  </div>
</div>

<!-- ‚îÄ‚îÄ Charts Row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="row g-3 mb-4">
  <div class="col-lg-7">
    <div class="card h-100">
      <div class="card-header">
        <i class="bi bi-bar-chart-fill text-success"></i> Monthly Expenses (Last 6 Months)
      </div>
      <div class="card-body">
        <div class="chart-box">
          <canvas id="expenseChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-5">
    <div class="card h-100">
      <div class="card-header">
        <i class="bi bi-pie-chart-fill text-warning"></i> Profit by Crop
      </div>
      <div class="card-body">
        <div class="chart-box">
          <canvas id="profitChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Recent Crops + Upcoming Harvests ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="row g-3">
  <div class="col-lg-7">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-clock-history"></i> Recent Crops</span>
        <a href="{{ url_for('crops') }}" class="btn btn-sm btn-outline-farm">View All</a>
      </div>
      <div class="card-body p-0">
        {% if recent_crops %}
        <div class="table-responsive">
          <table class="table farm-table mb-0">
            <thead>
              <tr>
                <th>Crop</th><th>Seeded On</th><th>Status</th>
                <th class="text-end">Investment</th>
              </tr>
            </thead>
            <tbody>
              {% for crop in recent_crops %}
              <tr>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    {% if crop.image_path %}
                    <img src="{{ url_for('static', filename='uploads/' + crop.image_path) }}"
                         class="crop-thumb" alt="{{ crop.name }}">
                    {% else %}
                    <div class="crop-thumb-placeholder">üåø</div>
                    {% endif %}
                    <div>
                      <div class="fw-700">{{ crop.name }}</div>
                      {% if crop.variety %}<small class="text-muted">{{ crop.variety }}</small>{% endif %}
                    </div>
                  </div>
                </td>
                <td>{{ crop.seeding_date.strftime('%d %b %Y') }}</td>
                <td>
                  <span class="badge badge-status {% if crop.status == 'Growing' %}badge-growing{% else %}badge-harvested{% endif %}">
                    {% if crop.status == 'Growing' %}üå±{% else %}üåæ{% endif %} {{ crop.status }}
                  </span>
                </td>
                <td class="text-end fw-700">‚Çπ{{ '{:,.0f}'.format(crop.total_investment) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
          <div style="font-size:3rem">üå±</div>
          <p class="mt-2">No crops added yet.</p>
          <a href="{{ url_for('crop_add') }}" class="btn btn-farm btn-sm">Add First Crop</a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <!-- Upcoming Harvests -->
    <div class="card mb-3">
      <div class="card-header">
        <i class="bi bi-calendar-check"></i> Upcoming Harvests (30 days)
      </div>
      <div class="card-body">
        {% if upcoming %}
          {% for crop in upcoming %}
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center gap-2">
              <div style="width:38px;height:38px;background:var(--amber-pale);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;">üåæ</div>
              <div>
                <div class="fw-700">{{ crop.name }}</div>
                <small class="text-muted">{{ crop.field_area }} acres</small>
              </div>
            </div>
            <div class="text-end">
              <span class="badge badge-status" style="background:#fff3cd;color:#856404;">
                {{ crop.expected_harvest.strftime('%d %b') }}
              </span>
              {% set days_left = (crop.expected_harvest - today).days if today else 0 %}
              <div style="font-size:.72rem;color:var(--text-muted);">{{ days_left }} days left</div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-center text-muted py-3">
            <i class="bi bi-calendar3" style="font-size:2rem;opacity:.3"></i>
            <p class="mt-2 mb-0 small">No upcoming harvests in next 30 days.</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
      <div class="card-header"><i class="bi bi-lightning-charge"></i> Quick Actions</div>
      <div class="card-body d-flex flex-column gap-2">
        <a href="{{ url_for('crop_add') }}"    class="btn btn-farm btn-sm"><i class="bi bi-plus-lg me-2"></i>Add New Crop</a>
        <a href="{{ url_for('expense_add') }}" class="btn btn-amber btn-sm"><i class="bi bi-receipt me-2"></i>Record Expense</a>
        <a href="{{ url_for('labour_add') }}"  class="btn btn-outline-farm btn-sm"><i class="bi bi-person-plus me-2"></i>Add Labour</a>
        <a href="{{ url_for('harvest_add') }}" class="btn btn-outline-farm btn-sm"><i class="bi bi-basket3 me-2"></i>Record Harvest</a>
        <a href="{{ url_for('reports') }}"     class="btn btn-outline-secondary btn-sm"><i class="bi bi-download me-2"></i>Download Reports</a>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
const chartLabels  = {{ chart_labels  | tojson }};
const chartExpense = {{ chart_expense | tojson }};
const cropNames    = {{ crop_names    | tojson }};
const cropProfits  = {{ crop_profits  | tojson }};

// ‚îÄ‚îÄ Monthly Expense Bar Chart ‚îÄ‚îÄ
const expCtx = document.getElementById('expenseChart').getContext('2d');
new Chart(expCtx, {
  type: 'bar',
  data: {
    labels: chartLabels.length ? chartLabels : ['No data'],
    datasets: [{
      label: 'Expenses (‚Çπ)',
      data: chartExpense.length ? chartExpense : [0],
      backgroundColor: 'rgba(74,124,47,.75)',
      borderColor: 'rgba(74,124,47,1)',
      borderWidth: 2, borderRadius: 6,
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      y: {
        beginAtZero: true,
        ticks: { callback: v => '‚Çπ' + v.toLocaleString() }
      }
    }
  }
});

// ‚îÄ‚îÄ Crop Profit Doughnut Chart ‚îÄ‚îÄ
const profCtx = document.getElementById('profitChart').getContext('2d');
const colors  = ['#4a7c2f','#7ab648','#e8a020','#6b4226','#c8956c','#27ae60','#e74c3c'];

new Chart(profCtx, {
  type: 'doughnut',
  data: {
    labels: cropNames.length ? cropNames : ['No data'],
    datasets: [{
      data: cropProfits.length ? cropProfits.map(v => Math.max(v, 0)) : [1],
      backgroundColor: colors,
      borderWidth: 3, borderColor: '#fff',
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom', labels: { padding: 16, font: { size: 12 } } },
      tooltip: {
        callbacks: {
          label: ctx => ' ‚Çπ' + ctx.raw.toLocaleString('en-IN')
        }
      }
    },
    cutout: '65%'
  }
});
</script>
{% endblock %}