{% extends 'base.html' %}
{% block title %}Growth Photo Gallery{% endblock %}
{% block page_title %}ðŸ“· Crop Growth Gallery{% endblock %}
{% block page_subtitle %}All crop growth photos across your farm{% endblock %}

{% block extra_head %}
<style>
  /* â”€â”€ Masonry-style Grid â”€â”€ */
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 16px;
  }

  .gallery-card {
    border-radius: 14px;
    overflow: hidden;
    border: 2px solid var(--cream-dark);
    background: #fff;
    box-shadow: 0 2px 12px rgba(0,0,0,.07);
    transition: all .25s ease;
    cursor: pointer;
    position: relative;
  }
  .gallery-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 32px rgba(0,0,0,.15);
    border-color: var(--green-light);
    z-index: 10;
  }
  .gallery-card img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    display: block;
    transition: transform .3s;
  }
  .gallery-card:hover img { transform: scale(1.06); }

  /* Overlay on hover */
  .gallery-card .overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,.7) 0%, transparent 55%);
    opacity: 0;
    transition: opacity .25s;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 14px;
    color: #fff;
  }
  .gallery-card:hover .overlay { opacity: 1; }
  .overlay .crop-name-ov  { font-weight: 700; font-size: .95rem; }
  .overlay .week-ov       { font-size: .78rem; opacity: .85; }
  .overlay .stage-ov      { font-size: .72rem; background:rgba(255,255,255,.2); padding:2px 8px; border-radius:10px; display:inline-block; margin-top:4px; }

  /* Crop Name Badge (always visible) */
  .crop-badge-corner {
    position: absolute;
    top: 10px; left: 10px;
    background: rgba(45,80,22,.85);
    color: #d4edba;
    font-size: .68rem;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 20px;
    backdrop-filter: blur(4px);
  }

  /* Lightbox */
  .lightbox-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.93);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 20px;
  }
  .lightbox-overlay.open { display: flex; }
  .lightbox-img {
    max-height: 78vh;
    max-width: 90vw;
    object-fit: contain;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,.6);
  }
  .lightbox-info {
    color: #fff;
    margin-top: 14px;
    text-align: center;
  }
  .lightbox-close {
    position: fixed;
    top: 18px; right: 24px;
    background: rgba(255,255,255,.12);
    border: none;
    color: #fff;
    font-size: 1.6rem;
    border-radius: 50%;
    width: 44px; height: 44px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }
  .lightbox-nav {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255,255,255,.12);
    border: none;
    color: #fff;
    font-size: 1.5rem;
    width: 48px; height: 48px;
    border-radius: 50%;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }
  .lightbox-nav.prev { left: 16px; }
  .lightbox-nav.next { right: 16px; }

  /* Filter bar */
  .filter-chip {
    padding: 6px 16px;
    border-radius: 30px;
    border: 2px solid var(--cream-dark);
    background: #fff;
    font-size: .82rem;
    font-weight: 600;
    color: var(--text-mid);
    cursor: pointer;
    transition: all .15s;
    white-space: nowrap;
  }
  .filter-chip.active {
    background: var(--green-mid);
    color: #fff;
    border-color: var(--green-mid);
  }
  .filter-chip:hover:not(.active) {
    border-color: var(--green-light);
    background: var(--green-pale);
    color: var(--green-dark);
  }
</style>
{% endblock %}

{% block content %}

<!-- â”€â”€ Header Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="row g-3 mb-4">
  <div class="col-sm-4">
    <div class="card text-center p-3">
      <div style="font-size:2rem;">ðŸ“¸</div>
      <div style="font-family:'Lora',serif;font-size:1.8rem;font-weight:700;color:var(--green-dark);">
        {{ total_photos }}
      </div>
      <div style="font-size:.78rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.8px;">Total Photos</div>
    </div>
  </div>
  <div class="col-sm-4">
    <div class="card text-center p-3">
      <div style="font-size:2rem;">ðŸŒ¿</div>
      <div style="font-family:'Lora',serif;font-size:1.8rem;font-weight:700;color:var(--green-dark);">
        {{ crops|length }}
      </div>
      <div style="font-size:.78rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.8px;">Crops Tracked</div>
    </div>
  </div>
  <div class="col-sm-4">
    <div class="card text-center p-3">
      <div style="font-size:2rem;">ðŸ“…</div>
      <div style="font-family:'Lora',serif;font-size:1.8rem;font-weight:700;color:var(--green-dark);">
        {{ photos[0].taken_date.strftime('%d %b') if photos else 'â€”' }}
      </div>
      <div style="font-size:.78rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.8px;">Latest Photo</div>
    </div>
  </div>
</div>

<!-- â”€â”€ Filter Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="d-flex gap-2 align-items-center flex-wrap mb-4">
  <span style="font-size:.82rem;font-weight:700;color:var(--text-muted);">Filter:</span>
  <button class="filter-chip active" onclick="filterCrop('all', this)">All Crops</button>
  {% for crop in crops %}
  <button class="filter-chip" onclick="filterCrop('{{ crop.id }}', this)">
    ðŸŒ¿ {{ crop.name }}
  </button>
  {% endfor %}

  <div class="ms-auto">
    {% for crop in crops %}
    <a href="{{ url_for('crop_photo_upload', crop_id=crop.id) }}"
       class="btn btn-farm btn-sm">
      <i class="bi bi-camera-fill me-1"></i>Upload Photo
    </a>
    {% if not loop.last %} {% endif %}
    {% endfor %}
  </div>
</div>

<!-- â”€â”€ Gallery Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
{% if photos %}
<div class="gallery-grid" id="galleryGrid">
  {% for photo in photos %}
  <div class="gallery-card" data-crop-id="{{ photo.crop_id }}"
       onclick="openLightbox({{ loop.index0 }})">

    <span class="crop-badge-corner">{{ photo.crop.name }}</span>

    <img src="/uploads/crop_photos/{{ photo.photo_path }}"
         alt="{{ photo.caption or photo.crop.name }}"
         loading="lazy">

    <div class="overlay">
      <div class="crop-name-ov">{{ photo.crop.name }}</div>
      <div class="week-ov">
        Week {{ photo.week_number or '?' }}
        &nbsp;Â·&nbsp;
        {{ photo.taken_date.strftime('%d %b %Y') }}
      </div>
      {% if photo.growth_stage %}
      <span class="stage-ov">{{ photo.growth_stage }}</span>
      {% endif %}
      {% if photo.caption %}
      <div style="font-size:.75rem;margin-top:4px;opacity:.8;">{{ photo.caption }}</div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<!-- View per-crop timelines -->
<div class="row g-3 mt-4">
  {% for crop in crops %}
  <div class="col-sm-6 col-lg-4">
    <a href="{{ url_for('crop_photos', crop_id=crop.id) }}"
       class="card text-decoration-none" style="transition:.2s"
       onmouseenter="this.style.transform='translateY(-3px)'"
       onmouseleave="this.style.transform='translateY(0)'">
      <div class="card-body d-flex align-items-center gap-3">
        <div style="width:46px;height:46px;background:var(--green-pale);border-radius:10px;
                    display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;">
          ðŸŒ¿
        </div>
        <div>
          <div style="font-weight:700;color:var(--green-dark);">{{ crop.name }}</div>
          <div style="font-size:.78rem;color:var(--text-muted);">
            {{ crop.total_photos }} photo{{ 's' if crop.total_photos != 1 else '' }}
            &nbsp;Â·&nbsp;
            <span class="{% if crop.status=='Growing' %}text-profit{% else %}text-muted{% endif %}">
              {{ crop.status }}
            </span>
          </div>
        </div>
        <i class="bi bi-chevron-right ms-auto text-muted"></i>
      </div>
    </a>
  </div>
  {% endfor %}
</div>

{% else %}
<!-- Empty State -->
<div class="card">
  <div class="card-body text-center py-5">
    <div style="font-size:5rem;">ðŸ“·</div>
    <h4 class="mt-3" style="color:var(--green-dark);">No growth photos yet</h4>
    <p class="text-muted">Start tracking your crop's growth by uploading weekly photos.</p>
    {% if crops %}
    <a href="{{ url_for('crop_photo_upload', crop_id=crops[0].id) }}" class="btn btn-farm mt-2">
      <i class="bi bi-camera-fill me-2"></i>Upload First Photo
    </a>
    {% else %}
    <a href="{{ url_for('crop_add') }}" class="btn btn-farm mt-2">
      <i class="bi bi-plus-lg me-2"></i>Add a Crop First
    </a>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="lightbox-overlay" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close" onclick="closeLightbox()">âœ•</button>
  <button class="lightbox-nav prev" onclick="event.stopPropagation();navLightbox(-1)">â€¹</button>
  <img class="lightbox-img" id="lightboxImg" src="" alt="">
  <div class="lightbox-info">
    <div id="lightboxCrop"    style="font-size:1rem;font-weight:700;color:#d4edba;"></div>
    <div id="lightboxCaption" style="font-size:.85rem;opacity:.8;margin-top:4px;"></div>
  </div>
  <button class="lightbox-nav next" onclick="event.stopPropagation();navLightbox(1)">â€º</button>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// All photos for lightbox
const allPhotos = [
  {% for photo in photos %}
  {
    src    : "/uploads/crop_photos/{{ photo.photo_path }}",
    crop   : "{{ photo.crop.name }}",
    caption: "Week {{ photo.week_number or '?' }} Â· {{ photo.taken_date.strftime('%d %b %Y') }}{{ ' â€” ' + photo.caption if photo.caption else '' }}",
    cropId : "{{ photo.crop_id }}",
  },
  {% endfor %}
];

let currentIdx = 0;
let visibleCards = [...document.querySelectorAll('.gallery-card')];

function openLightbox(idx) {
  currentIdx = idx;
  showLightboxPhoto();
  document.getElementById('lightbox').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeLightbox() {
  document.getElementById('lightbox').classList.remove('open');
  document.body.style.overflow = '';
}
function showLightboxPhoto() {
  if (!allPhotos.length) return;
  currentIdx = ((currentIdx % allPhotos.length) + allPhotos.length) % allPhotos.length;
  document.getElementById('lightboxImg').src        = allPhotos[currentIdx].src;
  document.getElementById('lightboxCrop').textContent    = 'ðŸŒ¿ ' + allPhotos[currentIdx].crop;
  document.getElementById('lightboxCaption').textContent = allPhotos[currentIdx].caption;
}
function navLightbox(dir) { currentIdx += dir; showLightboxPhoto(); }

// Filter by crop
function filterCrop(cropId, btn) {
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');

  document.querySelectorAll('.gallery-card').forEach(card => {
    if (cropId === 'all' || card.dataset.cropId === cropId) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}

// Keyboard nav
document.addEventListener('keydown', e => {
  if (!document.getElementById('lightbox').classList.contains('open')) return;
  if (e.key === 'ArrowRight') navLightbox(1);
  if (e.key === 'ArrowLeft')  navLightbox(-1);
  if (e.key === 'Escape')     closeLightbox();
});
</script>
{% endblock %}