{% extends 'base.html' %}
{% block title %}Fertilizer Guide{% endblock %}
{% block page_title %}üíß Fertilizer Recommendation{% endblock %}
{% block page_subtitle %}Get stage-wise fertilizer advice for any crop{% endblock %}
{% block extra_head %}
<style>
.fert-card{border-radius:14px;border:2px solid var(--cream-dark);background:#fff;padding:18px 20px;margin-bottom:12px;transition:all .15s;}
.fert-card:hover{border-color:var(--green-light);box-shadow:0 4px 16px rgba(0,0,0,.08);}
.fert-card.priority-1{border-left:5px solid var(--green-mid);}
.fert-card.priority-2{border-left:5px solid var(--amber);}
.stage-pill{display:inline-block;padding:4px 14px;border-radius:20px;font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;}
.method-badge{background:#f0fdf4;color:#166534;padding:3px 10px;border-radius:8px;font-size:.75rem;font-weight:600;}
.qty-badge{background:var(--amber-pale);color:var(--amber-dark);padding:4px 12px;border-radius:8px;font-size:.82rem;font-weight:700;}
.stage-header{background:linear-gradient(90deg,var(--green-pale),transparent);border-radius:10px;padding:10px 16px;margin:18px 0 10px;border-left:4px solid var(--green-mid);}
</style>
{% endblock %}
{% block content %}
<div class="row g-4">
  <!-- LEFT: Form -->
  <div class="col-lg-4">
    <div class="card sticky-top" style="top:20px;">
      <div class="card-header"><i class="bi bi-droplet-half text-success"></i> Select Crop & Stage</div>
      <div class="card-body">
        <form method="POST">
          <div class="mb-3">
            <label class="form-label">üåæ Crop Name *</label>
            <select name="crop_name" class="form-select" required onchange="this.form.submit()">
              <option value="">-- Select Crop --</option>
              {% for c in all_crops %}
              <option value="{{ c }}" {% if c == crop_name %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
          </div>
          {% if stages %}
          <div class="mb-3">
            <label class="form-label">üå± Growth Stage</label>
            <select name="growth_stage" class="form-select">
              <option value="">All Stages</option>
              {% for s in stages %}
              <option value="{{ s }}" {% if s == stage %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </div>
          {% endif %}
          <button type="submit" class="btn btn-farm w-100">
            <i class="bi bi-search me-2"></i>Get Recommendations
          </button>
        </form>
        {% if crop_name %}
        <div class="mt-3 p-3" style="background:var(--green-pale);border-radius:10px;">
          <div style="font-size:.78rem;font-weight:700;color:var(--green-dark);">üí° Quick Tip</div>
          <div style="font-size:.8rem;color:var(--text-mid);margin-top:4px;">
            Always apply fertilizers when soil has adequate moisture. Avoid applying before heavy rain.
            Primary (green border) fertilizers are essential; Secondary (amber border) are beneficial.
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- RIGHT: Results -->
  <div class="col-lg-8">
    {% if searched and results %}
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h5 style="font-family:'Lora',serif;color:var(--green-dark);margin:0;">
        Fertilizer Schedule ‚Äî {{ crop_name }}
        {% if stage %}<small style="font-weight:400;color:var(--text-muted);"> ({{ stage }})</small>{% endif %}
      </h5>
      <span style="font-size:.78rem;color:var(--text-muted);">{{ results|length }} recommendations</span>
    </div>

    <!-- Group by stage -->
    {% set ns = namespace(prev_stage='') %}
    {% for r in results %}
      {% if r.growth_stage != ns.prev_stage %}
      <div class="stage-header">
        <strong style="color:var(--green-dark);">üìå {{ r.growth_stage }}</strong>
      </div>
      {% set ns.prev_stage = r.growth_stage %}
      {% endif %}
      <div class="fert-card priority-{{ r.priority }}">
        <div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
          <div style="flex:1;min-width:160px;">
            <div style="font-weight:700;font-size:1rem;color:var(--green-dark);">
              {{ r.fertilizer_name }}
              {% if r.priority == 1 %}
              <span style="font-size:.65rem;background:var(--green-pale);color:var(--green-dark);padding:2px 7px;border-radius:10px;margin-left:6px;font-weight:700;">PRIMARY</span>
              {% else %}
              <span style="font-size:.65rem;background:var(--amber-pale);color:var(--amber-dark);padding:2px 7px;border-radius:10px;margin-left:6px;font-weight:700;">SUPPLEMENTARY</span>
              {% endif %}
            </div>
            {% if r.timing %}
            <div style="font-size:.82rem;color:var(--text-muted);margin-top:4px;">
              <i class="bi bi-clock"></i> {{ r.timing }}
            </div>
            {% endif %}
            {% if r.notes %}
            <div style="font-size:.78rem;color:var(--text-mid);margin-top:6px;padding:6px 10px;background:var(--cream);border-radius:6px;">
              {{ r.notes }}
            </div>
            {% endif %}
          </div>
          <div class="text-end" style="flex-shrink:0;">
            {% if r.quantity_acre %}
            <div class="qty-badge mb-1">{{ r.quantity_acre }}<br><span style="font-size:.65rem;font-weight:400;">per acre</span></div>
            {% endif %}
            {% if r.method %}
            <div class="method-badge mt-1">{{ r.method }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}

    <!-- Print advice box -->
    <div style="background:#f0fdf4;border-radius:12px;padding:16px 18px;margin-top:16px;border:1.5px solid #86efac;">
      <strong style="color:#166534;">‚ö†Ô∏è Important Reminders:</strong>
      <ul style="margin:8px 0 0;padding-left:18px;font-size:.85rem;color:#166534;">
        <li>Always do soil testing before applying fertilizers for best results</li>
        <li>Never apply urea in waterlogged conditions ‚Äî it converts to ammonia and is lost</li>
        <li>Apply DAP/fertilizers in morning or evening, not in hot afternoon sun</li>
        <li>Primary fertilizers are must-apply; supplementary are for better quality/yield</li>
      </ul>
    </div>

    {% elif searched %}
    <div class="card text-center py-5">
      <div style="font-size:3.5rem;">üíß</div>
      <h5 class="mt-3">No data for this selection</h5>
      <p class="text-muted">Try selecting "All Stages" to see all recommendations.</p>
    </div>
    {% else %}
    <div class="card text-center py-5">
      <div style="font-size:4rem;">üå±</div>
      <h4 class="mt-3" style="color:var(--green-dark);">Select a crop to get fertilizer advice</h4>
      <p class="text-muted">Choose a crop from the left panel to see stage-wise fertilizer recommendations.</p>
      <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
        {% for c in all_crops[:6] %}
        <form method="POST" style="display:inline;">
          <input type="hidden" name="crop_name" value="{{ c }}">
          <button type="submit" class="btn btn-sm btn-outline-farm">üåø {{ c }}</button>
        </form>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}